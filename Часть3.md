# Работа с продуктами

Давайте теперь рассмотрим ситуацию, когда все наши приложения необходимо развернуть на другой машине.
Для этого есть две команды dam export и dam import.
При выполнении dam export указывается путь к текстовому файлу (показывает) `dam export apps.txt`.
В этот файл выгрузится список установленных приложений dam.
`cat apps.txt`

Теперь рассмотрим вторую команду dam import. Ее задача - развернуть продукт в системе, которым сейчас является текстовый файл.
В аргументах команды указываем путь к нашему текстовому файлу. `dam import ./apps.txt`
При выполнении, утилита сверяет, какие приложения уже установлены в системе и какие находятся в данном списке. И далее предлагает внести изменения в систему.
При подтверждении, в нашем случае, изменений нет. Поэтому нет и установки приложений.
Это подсвечено желтым цветом.

Теперь попробуем при помощи импорта восстановить удаленное приложение в системе.
Давайте удалим, например my-app: `dam rm my-app:1.0.0`
Посмотрим список приложений.
`dam list`
Приложение исчезло.
Делаем импорт командой `dam import ./apps.txt`
Мы видим, что dam нам предлагает установить my-app. В этом случае установленные приложения в системе будут соответствовать указанным в списке. Подтверждаем.
Снова смотрим список приложений.
`dam list`
my-app появилось в системе.

Следует отметить, что если установленных приложений в системе будет больше, чем их в списке. То лишние будут удалены. Например:
из текстового файла vi apps.txt давайте удалим строчку с mongodb. Сохраним.
И сделаем импорт `dam import ./apps.txt`. Мы видим, что при применении данного списка apps.txt приложении mongodb также будет удалено из системы.
Отменяю.
Можно сделать вывод, что система всегда приводится к состоянию, в соответствии со списком.

Теперь давайте создадим новый пустой файл экспорта touch empty.txt
И импортируем его `dam import ./empty.txt`
В в результате выполнения данной команды мы получим чистую систему.
Это лайфхак.

Таким образом двумя командами import и export мы работаем сразу с группой приложений. Данную группу можно назвать продуктом.
Обновляя списки приложений и их версии мы можем управлять обновлениями продукта в системе.

Но команда dam export имеет еще одну особенность. Она может создавать не только текстовые файлы, но и файлы-архивы, которые,
будут в себе содержать образы докер приложений.
Давайте посмотрим dam help export. Здесь мы видим флаг --all. С его помощью в результате экспорта cформируется архив.

`dam export --all ./apps.tar`
При выполнении данной команды dam находит в системе соответствующие docker образы и сохраняет их в виде файлов - 
это производится стандартными средствами апи docker. 
В конце подготовки архива dam добавляет к файлам свою метаинформацию с описанием и списком образов. И пакует все в единый архив.

Давайте посмотрим размер такого архива `du -sh apps.tar`
Далее этот архив можно на флешке перенести на другую машину без доступа к интернет. И там развернуть полноценный продукт, при помощи dam import
В этом случае образы загрузятся из архивов в локальный кэш docker. И dam их установит

Например. Давайте полностью удалим приложение my-app и его образ, чтобы эмулировать установку и обновление на другой машине.
`dam rm my-app`
`docker rmi -f my-app:1.0.0`
и развернем данный архив с образами в системе
`dam import apps.tar`
`dam list` показывает, что система приведена к состоянию, которое было указано в архиве. Образ докер также загрузился в локальный кэш.

Дополнительно, если смотреть help  у `dam help import` - можно заметить флаг `--restore`.
Задача данного флага выполнить import с предварительной очисткой системы.
Выполним команду с данным флагом `dam import --restore ./apps.txt`
При его использовании dam в начале полностью удалит все приложения из системы, потом установит те, которые указаны в списке.
Отменяем.

Итак мы познакомились с управлением продуктом. Но сохранение в виде архива возможно и для одного приложения.
Для этого используется команда dam (help) save.
Данный архив не будет иметь метаинформацию о списке образов и может быть загружен стандартными средствами - это командой docker load.

В аргументах данной команды идут либо тэг приложения (в том случае если мы хотим сохранять из кэша) или имя двоеточие версия.

Выполним `dam save my-app:1.0.0`
Мы не указывали флагом `-f` с каким именем сохранить архив, поэтому его имя сгенерировано автоматически.

Оно содержит: имя приложения, его версия. хэш и расширение.
В текущей версии dam этот архив tar gz.

Устанавливается данное приложение также через команду `dam install my-app-1.0.0.cdc5d742.dam`
(в аргументах данной команды указывается абсолютный или относительный путь к файлу)
Пробуем его установить. Нам выводится ошибка, что приложение уже существует в системе. Удаляем его
`dam rm my-app`
И повторно устанавливаем из архива. Успех.